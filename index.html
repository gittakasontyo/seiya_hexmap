<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スマホ対応ヘキサマップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    svg { width: 100vw; height: 100vh; background: #f9f9f9; }
    select { font-size: 18px; padding: 4px; }

    #tooltip {
      position: absolute;
      display: none;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #666;
      padding: 8px 10px;
      font-size: 18px;
      border-radius: 6px;
      max-width: 90vw;
      z-index: 100;
      pointer-events: none;
    }
  </style>
</head>
<body>
<div style="padding: 6px; background: #eee;">
  敵選択：<select id="enemySelector"><option value="">（すべて表示）</option></select>
</div>
<svg id="hexmap"></svg>
<div id="tooltip"></div>
<script>
const csvUrl = "seiyaMap.csv?t=" + new Date().getTime();
const hexRadius = 36;
const sqrt3 = Math.sqrt(3);

function hexToPixel(col, row) {
  return [
    hexRadius * sqrt3 * (col + 0.5 * (row % 2)),
    hexRadius * 1.5 * row
  ];
}

function polygonPath(x, y) {
  let path = "";
  for (let i = 0; i < 6; i++) {
    const angle = Math.PI / 180 * (60 * i - 30);
    path += (i === 0 ? "M" : "L") + (x + hexRadius * Math.cos(angle)) + "," + (y + hexRadius * Math.sin(angle));
  }
  return path + "Z";
}

function getRankColor(rank) {
  const r = parseInt(rank);
  return ["#ccc", "#ffff99", "#ffcc66", "#ff9966", "#ff6666", "#cc3333"][r - 1] || "#fff";
}

function getTextColorByFighter(f) {
  if (f.includes("風")) return "#007700";
  if (f.includes("水")) return "#005577";
  if (f.includes("火") || f.includes("炎")) return "#cc0000";
  if (f.includes("土")) return "#8b4513";
  if (f.includes("光")) return "#ccaa00";
  if (f.includes("闇")) return "#660099";
  return "#000";
}

const svg = d3.select("#hexmap");
const g = svg.append("g");
const tooltip = d3.select("#tooltip");
const selector = d3.select("#enemySelector");

const zoom = d3.zoom().scaleExtent([0.5, 5]).on("zoom", e => g.attr("transform", e.transform));
svg.call(zoom);

fetch(csvUrl).then(r => r.text()).then(text => {
  const rows = d3.csvParse(text);
  const data = rows.filter(d => d["エリア"]).map(d => {
    const area = parseFloat(d["エリア"]);
    return {
      col: Math.floor(area),
      row: Math.round((area % 1) * 100),
      rank: d["タウンランク"] || "",
      fighter: d["派遣闘士"] || "",
      enemy1: d["敵①"] || "",
      enemy2: d["敵②"] || "",
      enemy3: d["敵③"] || ""
    };
  });

  const enemySet = new Set();
  data.forEach(d => [d.enemy1, d.enemy2, d.enemy3].forEach(e => e && enemySet.add(e.trim())));
  [...enemySet].sort().forEach(e => selector.append("option").attr("value", e).text(e));

  const dataMap = new Map(data.map(d => [`${d.col},${d.row}`, d]));
  const hexes = [];

  data.forEach(cell => {
    const [x, y] = hexToPixel(cell.col, cell.row);
    const group = g.append("g");

    const hex = group.append("path")
      .attr("d", polygonPath(x, y))
      .attr("fill", getRankColor(cell.rank))
      .attr("stroke", "#888");

    const rank = group.append("text")
      .attr("x", x).attr("y", y - 12).attr("text-anchor", "middle")
      .attr("font-size", "11px").attr("fill", "#444").text(`R${cell.rank}`);

    const fighter = group.append("text")
      .attr("x", x).attr("y", y + 0).attr("text-anchor", "middle")
      .attr("font-size", "13px").attr("fill", getTextColorByFighter(cell.fighter)).text(cell.fighter);

    const coord = group.append("text")
      .attr("x", x).attr("y", y + 13).attr("text-anchor", "middle")
      .attr("font-size", "9px").attr("fill", "#333").text(`(${cell.col},${cell.row})`);

    [hex, rank, fighter, coord].forEach(el => {
      el.on("click", e => {
        tooltip.style("left", `${e.pageX + 5}px`).style("top", `${e.pageY + 5}px`)
          .html(`<strong>${cell.fighter}</strong><br>${cell.enemy1 || ""}<br>${cell.enemy2 || ""}<br>${cell.enemy3 || ""}`)
          .style("display", "block");
      });
    });

    hexes.push({ cell, element: hex });
  });

  selector.on("change", () => {
    const sel = selector.property("value");
    hexes.forEach(({ cell, element }) => {
      const match = [cell.enemy1, cell.enemy2, cell.enemy3].includes(sel);
      element.attr("fill", match ? "#00ffff" : getRankColor(cell.rank));
    });
  });
});

document.body.addEventListener("click", () => tooltip.style("display", "none"));
</script>
</body>
</html>
